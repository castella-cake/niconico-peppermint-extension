Niconico-PepperMint+ はオープンソースであり、貢献を歓迎します。   
ここには、貢献をする際に役立つ情報などをまとめています。

なお、このドキュメントは全体的に仮段階に近いため、情報が不十分かもしれません。   
不明な点があれば、いつでもIssue経由で質問してください。

# 各部名称
- Niconico-PepperMint+ は PepperMint+, PM+ と省略できます
- MintWatch は 内部名称として PMWatch (省略形として PMW)を使用します
- ダークモード/カラーパレット は ダークモード を使用します
- 特定のページに対するダークモード用スタイルは ダークモードサポート と呼びます
- Manifest V3, Manifest V2 は MV3, MV2 のように省略できます

# Issue を建てる
もちろん Issue は大歓迎です！   
バグ報告を行う場合は、以下の内容を最低限記載することを推奨します:
(今のところテンプレートを作るほどの余裕がありません…申し訳ないです)
- 期待される動作
- 実際の動作
- 再現手順
- 拡張機能のバージョン
- ブラウザに関する情報(ブラウザ名, バージョン)
- OS に関する情報(種類, バージョン)
また、Issueを建てる前に、それが他の拡張機能によって引き起こされたものではないかを確認してください。   
他にも、重複しているIssue がないかどうかも確認してください。

# Pull Request を送る
Pull Request も同様に歓迎します！   
バグ修正については基本的に問題がなければマージします。   

機能追加の Pull Request についてはPM+のコンセプト的にマージできない場合もあるので、   
実装する前に Issue などを通して事前に相談してください。

また、スペース4つのインデントで、名前付けは基本的にキャメルケースを推奨します。   

ただし、それがReactコンポーネントの場合はパスカルケースにしてください。(Reactの掟に反します)   
これに則って、Reactコンポーネントがメインのファイルのファイル名についてはパスカルケースで書くのも良いでしょう。

# 開発する
大前提として Node.js が要ります。NPM が動くことを確認しておいてください。   

リポジトリをクローンしたら、`npm install` で依存関係のインストールを行ってください。   
3.0.0からは WXT を使っています。そのため、HMRを含む開発サーバーを使えます。

> [!NOTE]
`web-ext.config.js`を見るとわかりますが、WXT においてデフォルトで起動する Runner は無効にしています。
これは、ランナーが起動するブラウザが資格情報を保持せず、ニコニコ動画に対する拡張機能開発には不向きであると考えたためです。   

> [!WARNING]
オレンジのPepperMint+アイコンは、拡張機能が開発サーバーによってビルドされている場合に使用されます。   
その場合、一部のスクリプトは開発サーバーがないと動作しないこともあるので、注意してください。

## Chromium系(Manifest V3)
`npm run dev` を実行すると、開発用のサーバーが起動します。    

通常のPM+の使用を妨げないために、ブラウザは別のプロファイルを使用することを推奨します。   

ブラウザの extensions ページを開き、デベロッパーモードを有効にしたら、「パッケージ化されていない拡張機能を読み込む」から、
`.output`フォルダーの`chrome-mv3`フォルダー内を選択してインストールします。

`npm run build` を実行すると、拡張機能をビルドします。
同じフォルダーに出力されるので、開発時と同様の手順でインストールできます。

`npm run zip` を実行すると、ストア提出用の ZIP ファイルが`.output`フォルダーに作成されます。

## Firefox系(Manifest V2)
`npm run dev:firefox` を実行すると、開発用のサーバーが起動します。   

`about:debug`ページを開き、「この Firefox」から、「一時的なアドオンを読み込む…」を選択して、   
`.output/firefox-mv2`フォルダーの`manifest.json`を選択します。   

アドオンは Firefox を閉じると削除されます。   
既に PepperMint+ がインストールされている場合は、そのバージョンに戻ります。   
> [!WARNING]
Firefoxのバグなのか、閉じた際にそのバージョンに戻らず、アドオンが削除されてしまう場合があります。   
その場合は、ストアから再度インストールすると、元のストレージの内容も含めて復元することが出来ます。   
開発時は Firefox に限らず、ストレージに重要なデータがある場合は、PepperMint+ の設定からインポートしておくことをおすすめします。   

`npm run build:firefox` を実行すると、拡張機能をビルドします。   
同じフォルダーに出力されるので、開発時と同様の手順でインストールできます。   

`npm run zip:firefox` を実行すると、ストア提出用の ZIP ファイルが`.output`フォルダーに作成されます。

# ディレクトリ構造
まずは WXT の [プロジェクト構造(英語)](https://wxt.dev/guide/essentials/project-structure.html) ページを読んでください。   
これに概ね従っていますが、一部そうではない箇所もあります。

`public` の`style/css` は、まだ CSS を直接ドキュメントに追加しているコードのために残されています。   
コンテンツスタイルとしてのスタイルシートは、`entrypoints/style`にあります。

`utils` フォルダーには、各機能に使われる汎用的な関数を含むファイルがいくつかあります。

`types` フォルダーは、ニコニコ動画データに関する型定義を含みます。   
(実際の JSON から変換したため一部不正確かもしれません。特にnullable)

`patches` フォルダーには、NPM パッケージのバグ修正があります。   
現在はdnd-kitのFirefoxで発生する問題を修正するためだけに存在しています。

## MintWatch
MintWatch に関わるファイルは、`components` フォルダーの `PMWatch` フォルダー内に配置されています。
`watch.tsx` がコンテンツスクリプトからロードされる最初の関数です。   

`index.styl` は、`watchUI.styl` を囲むために存在しているエントリポイントです。   
スタイルシートではHMRが機能しないことに注意が必要です。   
また、TSX から直接スタイルシートをインポートすることができません。
(Stylus-lang を用いた import がHMRの対象にならないため)

`watch_injector.ts` は、必要に応じて`<script>`要素を通して実行されるスクリプトです。   
MintWatch のプラグインとして動作します。このファイル内では、一切拡張機能のAPIを使用できません。

# 変更ログについて
[Keep a Changelog](https://keepachangelog.com/en/1.0.0/) に基づき、   
バージョン付けは[Semantic Versioning](https://semver.org/spec/v2.0.0.html) に従います。   

基本的に各ログは「～ました」の形で記述しています。

# コミットメッセージについて
これといった規則はありませんが、何をしたかを簡潔に書いてください。   
現状以下の通りのヘッダー規則があるので、できれば先頭に入れておいてください。   
(仮段階のため変更される可能性が大いにあります)
- PMWに関する変更: `PMW: `
- ポップアップや設定ページに関する変更: `PAGES: `
- 機能に関する変更: `TWEAKS: `
- ダークモードサポートに関する変更: `DMS: `
